---
name: Build and Release ODR Artifacts

on:
  workflow_dispatch:
    inputs:
      build_padenc:
        description: 'Build ODR-PadEnc'
        required: false
        default: true
        type: boolean
      build_audioenc:
        description: 'Build ODR-AudioEnc'
        required: false
        default: true
        type: boolean
      build_dabmux:
        description: 'Build ODR-DabMux'
        required: false
        default: true
        type: boolean
      build_dablin:
        description: 'Build DABlin'
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  ##################################
  # Build Jobs
  ##################################
  build_padenc:
    name: Build ODR-PadEnc Artifact
    runs-on: ${{ matrix.runner }}
    if: ${{ inputs.build_padenc }}
    container:
      image: ${{ matrix.image }}
    strategy:
      matrix:
        include:
          - os: debian13
            image: "debian:trixie-slim"
            arch: "amd64"
            runner: "ubuntu-24.04"
          - os: debian13
            image: "debian:trixie-slim"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "amd64"
            runner: "ubuntu-24.04"
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
          - os: alpine322
            image: "alpine:3.22"
            arch: "amd64"
            runner: "ubuntu-24.04"
    steps:
      - name: Checkout repository (for build.env file)
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            build.env
          sparse-checkout-cone-mode: false

      - name: Load configuration
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          # Export to environment
          {
            echo "VERSION=$ODR_PADENC_VERSION"
            echo "BRANCH=$ODR_PADENC_BRANCH"
            echo "REPO_URL=$ODR_PADENC_REPO"
            echo "SOFTWARE=ODR-PadEnc"
          } >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          if [ "${{ matrix.os }}" = "alpine322" ]; then
            apk add --no-cache \
              build-base automake autoconf libtool \
              imagemagick-dev \
              curl git
          else
            apt-get update && apt-get install -y --no-install-recommends \
              build-essential automake libtool \
              libmagickwand-dev \
              ca-certificates curl git && \
            apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          fi

      - name: Download or clone ODR-PadEnc
        run: |
          # Check if BRANCH starts with 'v' (indicating a version tag)
          if [[ "${BRANCH}" =~ ^v[0-9] ]]; then
            echo "Downloading tag ${BRANCH} from ${REPO_URL}"
            curl -L "${REPO_URL}/archive/refs/tags/${BRANCH}.tar.gz" | tar -xz
            mv ODR-PadEnc-* ODR-PadEnc
          else
            echo "Cloning branch ${BRANCH} from ${REPO_URL}"
            git clone --depth 1 --branch "${BRANCH}" "${REPO_URL}.git"
          fi

      - name: Build ODR-PadEnc
        working-directory: ODR-PadEnc
        run: |
          ./bootstrap
          ./configure
          make -j"$(nproc)"

      - name: Prepare output directory
        run: mkdir -p output

      - name: Copy built binary to output directory
        working-directory: ODR-PadEnc
        run: |
          BINARY_NAME="odr-padenc-${{ env.VERSION }}-${{ matrix.os }}-${{ matrix.arch }}"
          if [ -f odr-padenc ]; then
            cp odr-padenc "../output/$BINARY_NAME"
          elif [ -f src/odr-padenc ]; then
            cp src/odr-padenc "../output/$BINARY_NAME"
          else
            echo "Build failed: executable not found!" && exit 1
          fi

      - name: Upload ODR-PadEnc Artifact
        uses: actions/upload-artifact@v4
        with:
          name: odr-padenc-${{ env.VERSION }}-${{ matrix.os }}-${{ matrix.arch }}
          path: output/odr-padenc-${{ env.VERSION }}-${{ matrix.os }}-${{ matrix.arch }}

  build_audioenc:
    name: Build ODR-AudioEnc Artifact
    runs-on: ${{ matrix.runner }}
    if: ${{ inputs.build_audioenc }}
    container:
      image: ${{ matrix.image }}
    strategy:
      matrix:
        include:
          - os: debian13
            image: "debian:trixie-slim"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: full
          - os: debian13
            image: "debian:trixie-slim"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: minimal
          - os: debian13
            image: "debian:trixie-slim"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
            build: full
          - os: debian13
            image: "debian:trixie-slim"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
            build: minimal
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: full
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: minimal
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
            build: full
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
            build: minimal
          - os: alpine322
            image: "alpine:3.22"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: minimal
          - os: alpine322
            image: "alpine:3.22"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: full
    steps:
      - name: Checkout repository (for build.env file)
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            build.env
          sparse-checkout-cone-mode: false

      - name: Load configuration
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          # Export to environment
          {
            echo "VERSION=$ODR_AUDIOENC_VERSION"
            echo "BRANCH=$ODR_AUDIOENC_BRANCH"
            echo "REPO_URL=$ODR_AUDIOENC_REPO"
            echo "SOFTWARE=ODR-AudioEnc"
          } >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          if [ "${{ matrix.os }}" = "alpine322" ]; then
            # Enable community repository
            echo "https://dl-cdn.alpinelinux.org/alpine/v3.22/community" >> /etc/apk/repositories
            apk update
            apk add --no-cache \
              build-base automake autoconf libtool \
              zeromq-dev \
              alsa-lib-dev jack-dev vlc-dev \
              gstreamer-dev gst-plugins-base-dev \
              curl-dev curl git
          else
            apt-get update && apt-get install -y --no-install-recommends \
              build-essential automake libtool \
              libzmq3-dev libzmq5 \
              libasound2-dev libjack-jackd2-dev libvlc-dev \
              libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
              libcurl4-openssl-dev ca-certificates curl git && \
            apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          fi

      - name: Download or clone ODR-AudioEnc
        run: |
          # Check if BRANCH starts with 'v' (indicating a version tag)
          if [[ "${BRANCH}" =~ ^v[0-9] ]]; then
            echo "Downloading tag ${BRANCH} from ${REPO_URL}"
            curl -L "${REPO_URL}/archive/refs/tags/${BRANCH}.tar.gz" | tar -xz
            mv ODR-AudioEnc-* ODR-AudioEnc
          else
            echo "Cloning branch ${BRANCH} from ${REPO_URL}"
            git clone --depth 1 --branch "${BRANCH}" "${REPO_URL}.git"
          fi

      - name: Build ODR-AudioEnc
        working-directory: ODR-AudioEnc
        run: |
          ./bootstrap
          if [ "${{ matrix.build }}" = "full" ]; then
            ./configure --enable-alsa --enable-jack --enable-vlc --enable-gst
          else
            ./configure
          fi
          make -j"$(nproc)"

      - name: Prepare output directory
        run: mkdir -p output

      - name: Copy built binary to output directory
        working-directory: ODR-AudioEnc
        run: |
          BINARY_NAME="odr-audioenc-${{ env.VERSION }}-${{ matrix.build }}-${{ matrix.os }}-${{ matrix.arch }}"
          if [ -f odr-audioenc ]; then
            cp odr-audioenc "../output/$BINARY_NAME"
          elif [ -f src/odr-audioenc ]; then
            cp src/odr-audioenc "../output/$BINARY_NAME"
          else
            echo "Build failed: executable not found!" && exit 1
          fi

      - name: Upload ODR-AudioEnc Artifact
        uses: actions/upload-artifact@v4
        with:
          name: odr-audioenc-${{ env.VERSION }}-${{ matrix.build }}-${{ matrix.os }}-${{ matrix.arch }}
          path: output/odr-audioenc-${{ env.VERSION }}-${{ matrix.build }}-${{ matrix.os }}-${{ matrix.arch }}

  build_dabmux:
    name: Build ODR-DabMux Artifact
    runs-on: ${{ matrix.runner }}
    if: ${{ inputs.build_dabmux }}
    container:
      image: ${{ matrix.image }}
    strategy:
      matrix:
        include:
          - os: debian13
            image: "debian:trixie-slim"
            arch: "amd64"
            runner: "ubuntu-24.04"
          - os: debian13
            image: "debian:trixie-slim"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "amd64"
            runner: "ubuntu-24.04"
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
          - os: alpine322
            image: "alpine:3.22"
            arch: "amd64"
            runner: "ubuntu-24.04"
    steps:
      - name: Checkout repository (for build.env file)
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            build.env
          sparse-checkout-cone-mode: false

      - name: Load configuration
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          # Export to environment
          {
            echo "VERSION=$ODR_DABMUX_VERSION"
            echo "BRANCH=$ODR_DABMUX_BRANCH"
            echo "REPO_URL=$ODR_DABMUX_REPO"
            echo "SOFTWARE=ODR-DabMux"
          } >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          if [ "${{ matrix.os }}" = "alpine322" ]; then
            apk add --no-cache \
              build-base automake autoconf libtool \
              zeromq-dev \
              boost-dev \
              curl-dev curl git
          else
            apt-get update && apt-get install -y --no-install-recommends \
              build-essential automake libtool \
              libzmq3-dev libzmq5 \
              libboost-system-dev \
              libcurl4-openssl-dev ca-certificates curl git && \
            apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          fi

      - name: Download or clone ODR-DabMux
        run: |
          # Check if BRANCH starts with 'v' (indicating a version tag)
          if [[ "${BRANCH}" =~ ^v[0-9] ]]; then
            echo "Downloading tag ${BRANCH} from ${REPO_URL}"
            curl -L "${REPO_URL}/archive/refs/tags/${BRANCH}.tar.gz" | tar -xz
            mv ODR-DabMux-* ODR-DabMux
          else
            echo "Cloning branch ${BRANCH} from ${REPO_URL}"
            git clone --depth 1 --branch "${BRANCH}" "${REPO_URL}.git"
          fi

      - name: Build ODR-DabMux
        working-directory: ODR-DabMux
        run: |
          ./bootstrap.sh
          ./configure
          make -j"$(nproc)"

      - name: Prepare output directory
        run: mkdir -p output

      - name: Copy built binary to output directory
        working-directory: ODR-DabMux
        run: |
          BINARY_NAME="odr-dabmux-${{ env.VERSION }}-${{ matrix.os }}-${{ matrix.arch }}"
          if [ -f odr-dabmux ]; then
            cp odr-dabmux "../output/$BINARY_NAME"
          elif [ -f src/odr-dabmux ]; then
            cp src/odr-dabmux "../output/$BINARY_NAME"
          else
            echo "Build failed: executable not found!" && exit 1
          fi

      - name: Upload ODR-DabMux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: odr-dabmux-${{ env.VERSION }}-${{ matrix.os }}-${{ matrix.arch }}
          path: output/odr-dabmux-${{ env.VERSION }}-${{ matrix.os }}-${{ matrix.arch }}

  build_dablin_linux:
    name: Build DABlin Artifact (Linux)
    runs-on: ${{ matrix.runner }}
    if: ${{ inputs.build_dablin }}
    container:
      image: ${{ matrix.image }}
    strategy:
      matrix:
        include:
          - os: debian13
            image: "debian:trixie-slim"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: cli
          - os: debian13
            image: "debian:trixie-slim"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: gtk
          - os: debian13
            image: "debian:trixie-slim"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
            build: cli
          - os: debian13
            image: "debian:trixie-slim"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
            build: gtk
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: cli
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "amd64"
            runner: "ubuntu-24.04"
            build: gtk
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
            build: cli
          - os: ubuntu2404
            image: "ubuntu:24.04"
            arch: "arm64"
            runner: "ubuntu-24.04-arm"
            build: gtk
    steps:
      - name: Checkout repository (for build.env file)
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            build.env
          sparse-checkout-cone-mode: false

      - name: Load configuration
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          # Export to environment
          {
            echo "VERSION=$DABLIN_VERSION"
            echo "BRANCH=$DABLIN_BRANCH"
            echo "REPO_URL=$DABLIN_REPO"
            echo "SOFTWARE=DABlin"
          } >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            build-essential cmake \
            libfaad-dev libmpg123-dev libsdl2-dev \
            ca-certificates curl git

          if [ "${{ matrix.build }}" = "gtk" ]; then
            apt-get install -y --no-install-recommends libgtkmm-3.0-dev
          fi

          apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

      - name: Download or clone DABlin
        run: |
          # Check if BRANCH starts with 'v' or is a version number
          if [[ "${BRANCH}" =~ ^v?[0-9] ]]; then
            echo "Downloading tag ${BRANCH} from ${REPO_URL}"
            curl -L "${REPO_URL}/archive/refs/tags/${BRANCH}.tar.gz" | tar -xz
            mv dablin-* dablin
          else
            echo "Cloning branch ${BRANCH} from ${REPO_URL}"
            git clone --depth 1 --branch "${BRANCH}" "${REPO_URL}.git"
          fi

      - name: Build DABlin
        working-directory: dablin
        run: |
          mkdir build
          cd build

          if [ "${{ matrix.build }}" = "gtk" ]; then
            cmake .. -DUSE_GUI=ON
          else
            cmake .. -DUSE_GUI=OFF
          fi

          make -j"$(nproc)"

      - name: Prepare output directory
        run: mkdir -p output

      - name: Copy built binaries to output directory
        working-directory: dablin/build
        run: |
          if [ "${{ matrix.build }}" = "gtk" ]; then
            BINARY_NAME="dablin-${{ env.VERSION }}-gtk-${{ matrix.os }}-${{ matrix.arch }}"
            if [ -f dablin_gtk ]; then
              cp dablin_gtk "../../output/$BINARY_NAME"
            elif [ -f src/dablin_gtk ]; then
              cp src/dablin_gtk "../../output/$BINARY_NAME"
            else
              echo "Build failed: dablin_gtk not found!" && exit 1
            fi
          else
            # CLI version only
            CLI_BINARY_NAME="dablin-${{ env.VERSION }}-cli-${{ matrix.os }}-${{ matrix.arch }}"
            if [ -f dablin ]; then
              cp dablin "../../output/$CLI_BINARY_NAME"
            elif [ -f src/dablin ]; then
              cp src/dablin "../../output/$CLI_BINARY_NAME"
            else
              echo "Build failed: dablin not found!" && exit 1
            fi
          fi

      - name: Upload DABlin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dablin-${{ env.VERSION }}-${{ matrix.build }}-${{ matrix.os }}-${{ matrix.arch }}
          path: output/*

  build_dablin_macos:
    name: Build DABlin Artifact (macOS)
    runs-on: ${{ matrix.runner }}
    if: ${{ inputs.build_dablin }}
    strategy:
      matrix:
        include:
          - os: macos
            arch: "amd64"
            runner: "macos-15-intel"
            build: cli
          - os: macos
            arch: "amd64"
            runner: "macos-15-intel"
            build: gtk
          - os: macos
            arch: "arm64"
            runner: "macos-15"
            build: cli
          - os: macos
            arch: "arm64"
            runner: "macos-15"
            build: gtk
    steps:
      - name: Checkout repository (for build.env file)
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            build.env
          sparse-checkout-cone-mode: false

      - name: Load configuration
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          # Export to environment
          {
            echo "VERSION=$DABLIN_VERSION"
            echo "BRANCH=$DABLIN_BRANCH"
            echo "REPO_URL=$DABLIN_REPO"
            echo "SOFTWARE=DABlin"
          } >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          brew install cmake faad2 mpg123 sdl2

          if [ "${{ matrix.build }}" = "gtk" ]; then
            brew install gtkmm3
          fi

      - name: Download or clone DABlin
        run: |
          # Check if BRANCH starts with 'v' or is a version number
          if [[ "${BRANCH}" =~ ^v?[0-9] ]]; then
            echo "Downloading tag ${BRANCH} from ${REPO_URL}"
            curl -L "${REPO_URL}/archive/refs/tags/${BRANCH}.tar.gz" | tar -xz
            mv dablin-* dablin
          else
            echo "Cloning branch ${BRANCH} from ${REPO_URL}"
            git clone --depth 1 --branch "${BRANCH}" "${REPO_URL}.git"
          fi

      - name: Build DABlin
        working-directory: dablin
        run: |
          mkdir build
          cd build

          if [ "${{ matrix.build }}" = "gtk" ]; then
            cmake .. -DUSE_GUI=ON
          else
            cmake .. -DUSE_GUI=OFF
          fi

          make -j"$(sysctl -n hw.ncpu)"

      - name: Prepare output directory
        run: mkdir -p output

      - name: Copy built binaries to output directory
        working-directory: dablin/build
        run: |
          if [ "${{ matrix.build }}" = "gtk" ]; then
            BINARY_NAME="dablin-${{ env.VERSION }}-gtk-${{ matrix.os }}-${{ matrix.arch }}"
            if [ -f dablin_gtk ]; then
              cp dablin_gtk "../../output/$BINARY_NAME"
            elif [ -f src/dablin_gtk ]; then
              cp src/dablin_gtk "../../output/$BINARY_NAME"
            else
              echo "Build failed: dablin_gtk not found!" && exit 1
            fi
          else
            # CLI version only
            CLI_BINARY_NAME="dablin-${{ env.VERSION }}-cli-${{ matrix.os }}-${{ matrix.arch }}"
            if [ -f dablin ]; then
              cp dablin "../../output/$CLI_BINARY_NAME"
            elif [ -f src/dablin ]; then
              cp src/dablin "../../output/$CLI_BINARY_NAME"
            else
              echo "Build failed: dablin not found!" && exit 1
            fi
          fi

      - name: Upload DABlin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dablin-${{ env.VERSION }}-${{ matrix.build }}-${{ matrix.os }}-${{ matrix.arch }}
          path: output/*

  ##################################
  # Release Jobs
  ##################################
  release_padenc:
    name: Create GitHub Release for ODR-PadEnc
    runs-on: ubuntu-24.04
    needs: build_padenc
    if: ${{ inputs.build_padenc && !cancelled() && !failure() }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Load version
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          echo "VERSION=$ODR_PADENC_VERSION" >> "$GITHUB_ENV"

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: all_artifacts

      - name: Organize PadEnc artifacts
        run: |
          mkdir -p padenc
          mv all_artifacts/odr-padenc-* padenc/ || true
          ls -l padenc

      - name: Create PadEnc Release and Upload Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v2
        with:
          files: padenc/**
          tag_name: odr-padenc-${{ env.VERSION }}
          name: "ODR-PadEnc ${{ env.VERSION }}"
          generate_release_notes: false

  release_audioenc:
    name: Create GitHub Release for ODR-AudioEnc
    runs-on: ubuntu-24.04
    needs: build_audioenc
    if: ${{ inputs.build_audioenc && !cancelled() && !failure() }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Load version
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          echo "VERSION=$ODR_AUDIOENC_VERSION" >> "$GITHUB_ENV"

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: all_artifacts

      - name: Organize AudioEnc artifacts
        run: |
          mkdir -p audioenc
          mv all_artifacts/odr-audioenc-* audioenc/ || true
          ls -l audioenc

      - name: Create AudioEnc Release and Upload Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v2
        with:
          files: audioenc/**
          tag_name: odr-audioenc-${{ env.VERSION }}
          name: "ODR-AudioEnc ${{ env.VERSION }}"
          generate_release_notes: false

  release_dabmux:
    name: Create GitHub Release for ODR-DabMux
    runs-on: ubuntu-24.04
    needs: build_dabmux
    if: ${{ inputs.build_dabmux && !cancelled() && !failure() }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Load version
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          echo "VERSION=$ODR_DABMUX_VERSION" >> "$GITHUB_ENV"

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: all_artifacts

      - name: Organize DabMux artifacts
        run: |
          mkdir -p dabmux
          mv all_artifacts/odr-dabmux-* dabmux/ || true
          ls -l dabmux

      - name: Create DabMux Release and Upload Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v2
        with:
          files: dabmux/**
          tag_name: odr-dabmux-${{ env.VERSION }}
          name: "ODR-DabMux ${{ env.VERSION }}"
          generate_release_notes: false

  release_dablin:
    name: Create GitHub Release for DABlin
    runs-on: ubuntu-24.04
    needs: [build_dablin_linux, build_dablin_macos]
    if: ${{ inputs.build_dablin && !cancelled() && !failure() }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Load version
        run: |
          # Source build.env file
          set -a
          . ./build.env
          set +a

          echo "VERSION=$DABLIN_VERSION" >> "$GITHUB_ENV"

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: all_artifacts

      - name: Organize DABlin artifacts
        run: |
          mkdir -p dablin
          mv all_artifacts/dablin-* dablin/ || true
          ls -l dablin

      - name: Create DABlin Release and Upload Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v2
        with:
          files: dablin/**
          tag_name: dablin-${{ env.VERSION }}
          name: "DABlin ${{ env.VERSION }}"
          generate_release_notes: false

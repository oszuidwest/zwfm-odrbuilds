---
name: Code Quality

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      # Dockerfile linting (skipped if no Dockerfile exists)
      - name: Check for Dockerfile
        id: check_dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
          else
            echo "has_dockerfile=false" >> $GITHUB_OUTPUT
          fi

      - name: Hadolint
        if: steps.check_dockerfile.outputs.has_dockerfile == 'true'
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
          ignore: DL3008,DL3009

      # YAML linting (excludes workflow files to prevent formatting conflicts)
      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3.1.1
        with:
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              comments:
                min-spaces-from-content: 1
              truthy:
                allowed-values: ['true', 'false', 'on', 'off', 'yes', 'no']
              document-start:
                present: false

      # Docker Compose validation (skipped if no compose file exists)
      - name: Check for Docker Compose
        id: check_compose
        run: |
          if [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ] || [ -f "compose.yml" ] || [ -f "compose.yaml" ]; then
            echo "has_compose=true" >> $GITHUB_OUTPUT
          else
            echo "has_compose=false" >> $GITHUB_OUTPUT
          fi

      - name: Docker Compose Validation
        if: steps.check_compose.outputs.has_compose == 'true'
        run: |
          if [ ! -f ".env" ]; then
            touch .env
          fi
          docker compose config --quiet 2>&1 || echo "::warning::Docker Compose validation requires environment variables"
